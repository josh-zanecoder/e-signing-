{% extends 'pdf_signer/base.html' %} {% block content %}
<div class="preview-container">
  <h2>Sign Document</h2>

  {% if document %} {% if document.original_pdf %}
  <div class="document-workspace">
    <!-- PDF Viewer -->
    <div class="pdf-container">
      <div id="pageContainer">
        <canvas id="pdfCanvas"></canvas>
        <div id="signatureLayer" class="signature-layer"></div>
      </div>
      <div class="pdf-controls">
        <button id="prevPage" class="btn btn-secondary">Previous</button>
        <span id="pageInfo"
          >Page: <span id="pageNum">1</span> /
          <span id="pageCount">1</span></span
        >
        <button id="nextPage" class="btn btn-secondary">Next</button>
      </div>
    </div>

    <!-- Hidden Signature Panel - Shows only when clicking placeholder -->
    <div id="signaturePanel" class="signature-panel" style="display: none">
      <div class="signature-header">
        <h3>Draw Your Signature</h3>
        <button class="close-btn" onclick="hideSignaturePanel()">
          &times;
        </button>
      </div>
      <form id="signatureForm">
        {% csrf_token %}
        <div class="signature-pad-container">
          <canvas id="signaturePad" width="400" height="150"></canvas>
          <div class="signature-pad-buttons">
            <button type="button" id="clearButton" class="btn btn-secondary">
              Clear
            </button>
            <button type="button" id="confirmSignature" class="btn btn-primary">
              Place Signature
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Save button - Shows only after placing signature -->
  <div
    class="save-document-container"
    style="text-align: center; margin-top: 20px"
  >
    <button id="saveButton" class="btn btn-success" style="display: none">
      Save Signed Document
    </button>
    <div id="signature-result"></div>
  </div>
  {% endif %} {% else %}
  <p>No document found.</p>
  {% endif %}
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<style>
  .document-workspace {
    display: flex;
    gap: 20px;
    margin: 20px auto;
    max-width: 1200px;
    position: relative;
  }

  .pdf-container {
    flex: 1;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #f5f5f5;
    min-height: 800px;
    position: relative;
    overflow: auto;
  }

  #pageContainer {
    position: relative;
    margin: 0 auto;
  }

  #pdfCanvas {
    border: 1px solid #ddd;
  }

  .signature-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .pdf-controls {
    padding: 10px;
    display: flex;
    gap: 20px;
    align-items: center;
    justify-content: center;
    background: #fff;
    border-top: 1px solid #ddd;
  }

  .signature-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 1000;
  }

  .signature-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 0 5px;
  }

  .save-document-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
  }

  .btn-success {
    background-color: #28a745;
  }

  .instructions {
    margin: 10px 0;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 4px;
    font-size: 14px;
  }

  .signature-pad-container {
    width: 400px;
    padding: 10px;
  }

  #signaturePad {
    width: 400px !important;
    height: 150px !important;
    border: 1px solid #e0e0e0;
  }

  .signature-pad-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    color: white;
  }

  .btn-secondary {
    background: #6c757d;
  }

  .btn-primary {
    background: #007bff;
  }

  .success-message {
    color: green;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 4px;
    margin: 10px 0;
  }

  .error-message {
    color: red;
    padding: 10px;
    background: #ffebee;
    border-radius: 4px;
    margin: 10px 0;
  }

  .preview-container {
    padding: 20px;
  }

  h2 {
    margin-bottom: 20px;
  }

  .signature-preview img {
    max-width: 100%;
    height: auto;
  }

  .sign-here-marker {
    cursor: pointer !important;
    background: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #007bff;
    font-size: 14px;
    position: absolute;
    z-index: 100;
    padding: 10px;
    min-width: 150px;
    min-height: 50px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .signature-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  .sign-here-marker {
    pointer-events: auto;
  }
</style>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  document.addEventListener("DOMContentLoaded", async function () {
    let pdfDoc = null;
    let pageNum = 1;
    let signaturePositions = [];
    let currentSignPosition = null;
    const canvas = document.getElementById("pdfCanvas");
    const ctx = canvas.getContext("2d");
    const signatureLayer = document.getElementById("signatureLayer");
    const signaturePanel = document.getElementById("signaturePanel");
    const signaturePad = new SignaturePad(
      document.getElementById("signaturePad"),
      {
        backgroundColor: "rgb(255, 255, 255)",
        penColor: "rgb(0, 0, 0)",
        minWidth: 2,
        maxWidth: 4,
      }
    );

    // Load the PDF
    const loadingTask = pdfjsLib.getDocument("{{ document.original_pdf.url }}");
    loadingTask.promise.then(function (pdf) {
      pdfDoc = pdf;
      document.getElementById("pageCount").textContent = pdf.numPages;
      renderPage(pageNum);
    });

    function showSignaturePanel(position) {
      currentSignPosition = position;
      signaturePanel.style.display = "block";
      signaturePad.clear();
    }

    function hideSignaturePanel() {
      signaturePanel.style.display = "none";
      currentSignPosition = null;
    }

    async function renderPage(num) {
      const page = await pdfDoc.getPage(num);
      const viewport = page.getViewport({ scale: 1.5 });

      canvas.height = viewport.height;
      canvas.width = viewport.width;
      signatureLayer.style.width = `${viewport.width}px`;
      signatureLayer.style.height = `${viewport.height}px`;

      await page.render({
        canvasContext: ctx,
        viewport: viewport,
      }).promise;

      // Find and mark <<SIGN HERE>> placeholders
      const textContent = await page.getTextContent();
      textContent.items.forEach((item) => {
        if (item.str.includes("<<SIGN HERE>>")) {
          // Convert PDF coordinates to viewport coordinates
          const rect = viewport.convertToViewportRectangle([
            item.transform[4],
            item.transform[5] - 20,
            item.transform[4] + 150,
            item.transform[5] + 50,
          ]);

          const signHereDiv = document.createElement("div");
          signHereDiv.className = "sign-here-marker";
          signHereDiv.style.position = "absolute";
          signHereDiv.style.left = `${rect[0]}px`;
          signHereDiv.style.top = `${rect[1]}px`;
          signHereDiv.style.width = "150px";
          signHereDiv.style.height = "70px";
          signHereDiv.innerHTML = "<<SIGN HERE>>";

          // Add click event listener
          signHereDiv.onclick = function (e) {
            e.preventDefault();
            e.stopPropagation();
            currentSignPosition = {
              page: pageNum,
              rect: rect,
              element: signHereDiv,
            };
            document.getElementById("signaturePanel").style.display = "block";
          };

          // Also add touch event for mobile devices
          signHereDiv.addEventListener(
            "touchstart",
            function (e) {
              e.preventDefault();
              e.stopPropagation();
              currentSignPosition = {
                page: pageNum,
                rect: rect,
                element: signHereDiv,
              };
              document.getElementById("signaturePanel").style.display = "block";
            },
            false
          );

          signatureLayer.appendChild(signHereDiv);
        }
      });
    }

    // Make sure signature layer is clickable
    document.addEventListener("DOMContentLoaded", function () {
      const signatureLayer = document.getElementById("signatureLayer");
      signatureLayer.style.pointerEvents = "none"; // Allow clicks to pass through
    });

    // Handle signature placement
    document
      .getElementById("confirmSignature")
      .addEventListener("click", () => {
        if (signaturePad.isEmpty()) {
          alert("Please draw your signature first.");
          return;
        }

        if (currentSignPosition) {
          const signatureImg = new Image();
          signatureImg.src = signaturePad.toDataURL();

          signatureImg.onload = function () {
            const signatureDiv = document.createElement("div");
            signatureDiv.style.position = "absolute";
            signatureDiv.style.left = currentSignPosition.element.style.left;
            signatureDiv.style.top = currentSignPosition.element.style.top;
            signatureDiv.style.width = currentSignPosition.element.style.width;
            signatureDiv.style.height =
              currentSignPosition.element.style.height;

            const img = document.createElement("img");
            img.src = signatureImg.src;
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "contain";

            signatureDiv.appendChild(img);
            currentSignPosition.element.remove();
            signatureLayer.appendChild(signatureDiv);

            document.getElementById("signaturePanel").style.display = "none";
            document.getElementById("saveButton").style.display = "block";

            signaturePositions.push(currentSignPosition);
          };
        }
      });

    // Navigation buttons
    document.getElementById("prevPage").addEventListener("click", () => {
      if (pageNum <= 1) return;
      pageNum--;
      renderPage(pageNum);
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      renderPage(pageNum);
    });

    // Clear signature
    document.getElementById("clearButton").addEventListener("click", () => {
      signaturePad.clear();
    });

    // Save document
    document
      .getElementById("saveButton")
      .addEventListener("click", async function () {
        try {
          const csrfToken = document.querySelector(
            "[name=csrfmiddlewaretoken]"
          ).value;
          const signatureData = signaturePad.toDataURL();
          const formData = new FormData();
          formData.append("signature", signatureData);
          formData.append("positions", JSON.stringify(signaturePositions));

          const response = await fetch(
            "{% url 'pdf_signer:sign' document.id %}",
            {
              method: "POST",
              headers: {
                "X-CSRFToken": csrfToken,
              },
              body: formData,
            }
          );

          const data = await response.json();

          if (data.success) {
            document.getElementById("signature-result").innerHTML =
              '<div class="success-message">Document signed successfully!</div>';

            // Download the signed PDF
            window.location.href = data.download_url;
          } else {
            throw new Error(data.error || "Failed to sign document");
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "signature-result"
          ).innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
        }
      });
  });
</script>
{% endblock %}
